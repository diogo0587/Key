name: Auto-PWA-Builder-and-Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Create PWA structure
        run: |
          mkdir -p src
          mkdir -p public/icons
          
          # index.html
          cat << 'EOF' > src/index.html
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>PWA Gerado Automático</title>
            <link rel="manifest" href="/manifest.json" />
            <script src="/service-worker.js"></script>
          </head>
          <body>
            <h1>PWA criado automaticamente pelo GitHub Actions</h1>
          </body>
          </html>
          EOF

          # manifest.json
          cat << 'EOF' > public/manifest.json
          {
            "name": "PWA Automático",
            "short_name": "AutoPWA",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#000000",
            "icons": [
              {
                "src": "/icons/icon-192.png",
                "sizes": "192x192",
                "type": "image/png"
              },
              {
                "src": "/icons/icon-512.png",
                "sizes": "512x512",
                "type": "image/png"
              }
            ]
          }
          EOF

          # service worker
          cat << 'EOF' > public/service-worker.js
          self.addEventListener('install', e => {
            console.log('SW instalado');
            self.skipWaiting();
          });
          self.addEventListener('activate', e => {
            console.log('SW ativo');
          });
          EOF

          # coloca ícones placeholder
          convert -size 192x192 xc:blue public/icons/icon-192.png
          convert -size 512x512 xc:red public/icons/icon-512.png

      - name: Generate dist folder
        run: |
          mkdir -p dist
          cp -R src/* dist/
          cp -R public/* dist/

      - name: Vercel Pull
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        run: vercel deploy dist --prod --yes --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_SCOPE }}
