name: Auto-generate & Deploy Advanced PWA

permissions:
  contents: write
  id-token: write   # necessÃ¡rio para deploy-pages v4

on:
  push:
    branches:
      - main

jobs:
  generate-build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate full PWA with Admin + Base64 Icons
        run: |
          mkdir -p dist/public/icons

          # Base64 icons (transparente)
          ICON_192="iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAQAAAA=="
          ICON_512="iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAQAAAA=="

          # index.html
          cat > dist/index.html <<'HTML'
          <!doctype html>
          <html lang="pt-BR">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>PWA User App</title>
            <link rel="manifest" href="/manifest.json">
            <script defer src="main.js"></script>
          </head>
          <body>
            <h1>PWA User App</h1>
            <input type="text" id="inputBox" placeholder="Digite algo">
            <ul id="logList"></ul>
          </body>
          </html>
          HTML

          # admin.html
          cat > dist/admin.html <<'HTML'
          <!doctype html>
          <html lang="pt-BR">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Admin Dashboard</title>
            <style>
              body { font-family:sans-serif; }
              #logList li { margin-bottom:4px; }
              #filter { margin-bottom:10px; }
            </style>
            <script defer src="admin.js"></script>
          </head>
          <body>
            <h1>Admin Dashboard</h1>
            <input type="text" id="filter" placeholder="Filtrar logs">
            <p>Total: <span id="count">0</span></p>
            <ul id="logList"></ul>
          </body>
          </html>
          HTML

          # main.js
          cat > dist/main.js <<'JS'
          const input = document.getElementById('inputBox');
          const logList = document.getElementById('logList');
          const logs = JSON.parse(localStorage.getItem('userLogs')||'[]');
          function addLog(text){ const li=document.createElement('li'); li.textContent=text; logList.appendChild(li); }
          logs.forEach(addLog);
          input.addEventListener('input', e => {
            const v = e.target.value; if(!v) return;
            logs.push(v); localStorage.setItem('userLogs', JSON.stringify(logs));
            addLog(v); e.target.value='';
          });
          JS

          # admin.js
          cat > dist/admin.js <<'JS'
          const logList = document.getElementById('logList');
          const countEl = document.getElementById('count');
          const filterInput = document.getElementById('filter');
          let logs = JSON.parse(localStorage.getItem('userLogs')||'[]');
          function renderLogs(f=''){
            logList.innerHTML='';
            const filtered = logs.filter(l => l.toLowerCase().includes(f.toLowerCase()));
            filtered.forEach(item=>{const li=document.createElement('li');li.textContent=item;logList.appendChild(li);});
            countEl.textContent=filtered.length;
          }
          filterInput.addEventListener('input', e => renderLogs(e.target.value));
          renderLogs();
          JS

          # manifest.json com icons embutidos
          cat > dist/manifest.json <<JSON
          {
            "name": "PWA Auto Input Advanced",
            "short_name": "PWA Teste",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#317EFB",
            "icons": [
              {"src": "data:image/png;base64,${ICON_192}","sizes":"192x192","type":"image/png"},
              {"src": "data:image/png;base64,${ICON_512}","sizes":"512x512","type":"image/png"}
            ]
          }
          JSON

      - name: List dist folder
        run: ls -R dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pwa-build
          path: ./dist

      - name: Configure Pages
        uses: actions/configure-pages@v3

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          artifact_name: pwa-build
