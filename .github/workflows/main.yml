name: Auto-generate & Deploy PWA v4

on:
  push:
    branches:
      - main

jobs:
  generate-build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create PWA structure with base64 icons and auto input
        run: |
          mkdir -p src public/icons build

          # Manifest
          cat > public/manifest.json << 'EOF'
          {
            "name": "PWA Auto Input",
            "short_name": "PWA Teste",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#317EFB",
            "icons": [
              {"src": "/icons/icon-192.png","sizes": "192x192","type": "image/png"},
              {"src": "/icons/icon-512.png","sizes": "512x512","type": "image/png"}
            ]
          }
          EOF

          # HTML
          cat > src/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>PWA Auto Input</title>
            <link rel="manifest" href="/manifest.json">
            <script defer src="main.js"></script>
          </head>
          <body>
            <h1>PWA Auto Input</h1>
            <p>Digite algo e veja armazenado automaticamente:</p>
            <input type="text" id="inputBox" placeholder="Digite aqui">
            <ul id="logList"></ul>
          </body>
          </html>
          EOF

          # JS com registro automático
          cat > src/main.js << 'EOF'
          const input = document.getElementById('inputBox');
          const logList = document.getElementById('logList');
          const logs = JSON.parse(localStorage.getItem('keyLog') || '[]');
          logs.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            logList.appendChild(li);
          });
          function addLog(text){
            const li = document.createElement('li');
            li.textContent = text;
            logList.appendChild(li);
          }
          input.addEventListener('input', e => {
            const value = e.target.value;
            if(!value) return;
            logs.push(value);
            localStorage.setItem('keyLog', JSON.stringify(logs));
            addLog(value);
            e.target.value = '';
          });
          if('serviceWorker' in navigator){
            window.addEventListener('load', ()=>navigator.serviceWorker.register('/service-worker.js'));
          }
          EOF

          # Service Worker
          cat > service-worker.js << 'EOF'
          const cacheName='pwa-cache-v1';
          const filesToCache=['/','/src/index.html','/src/main.js','/public/manifest.json'];
          self.addEventListener('install', e=>e.waitUntil(caches.open(cacheName).then(c=>c.addAll(filesToCache))));
          self.addEventListener('fetch', e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));
          EOF

          # Ícones base64 (transparente PNG)
          for size in 192 512; do
            echo "iVBORw0KGgoAAAANSUhEUgAA$(($size))AAAB$RANDOM" | base64 --decode > public/icons/icon-${size}.png || echo "Use seus próprios ícones em public/icons/icon-${size}.png"
          done

      - name: Build PWA
        run: cp -r src/* build/

      - name: List build folder
        run: ls -R build

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: pwa-build
          path: ./build

      - name: Configure Pages
        uses: actions/configure-pages@v3

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          folder: ./build
