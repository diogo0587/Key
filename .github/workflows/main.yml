name: Deploy PWA

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Criar diretórios
        run: |
          mkdir -p dist
          mkdir -p dist/icons

      - name: index.html
        run: |
          echo '<!doctype html>' > dist/index.html
          echo '<html lang="pt-BR">' >> dist/index.html
          echo '<head>' >> dist/index.html
          echo '  <meta charset="utf-8">' >> dist/index.html
          echo '  <meta name="viewport" content="width=device-width,initial-scale=1">' >> dist/index.html
          echo '  <title>Keyboard Monitor</title>' >> dist/index.html
          echo '  <link rel="stylesheet" href="style.css">' >> dist/index.html
          echo '  <link rel="manifest" href="manifest.json">' >> dist/index.html
          echo '</head>' >> dist/index.html
          echo '<body>' >> dist/index.html
          echo '  <h1>Keyboard Monitor</h1>' >> dist/index.html
          echo '  <textarea id="area" placeholder="Digite aqui..."></textarea>' >> dist/index.html
          echo '  <script src="app.js"></script>' >> dist/index.html
          echo '  <script>if("serviceWorker" in navigator){navigator.serviceWorker.register("service-worker.js");}</script>' >> dist/index.html
          echo '</body>' >> dist/index.html
          echo '</html>' >> dist/index.html

      - name: style.css
        run: |
          echo 'body { background:#eee; font-family:Arial; padding:20px; }' > dist/style.css
          echo 'textarea { width:100%; height:200px; font-size:16px; }' >> dist/style.css

      - name: app.js
        run: |
          echo 'let events=[];' > dist/app.js
          echo 'const area=document.getElementById("area");' >> dist/app.js
          echo 'area.addEventListener("keydown",e=>{' >> dist/app.js
          echo '  events.push({key:e.key,code:e.code,time:Date.now()});' >> dist/app.js
          echo '});' >> dist/app.js

      - name: manifest.json
        run: |
          echo '{' > dist/manifest.json
          echo '  "name": "Keyboard Monitor",' >> dist/manifest.json
          echo '  "short_name": "KeyMon",' >> dist/manifest.json
          echo '  "start_url": ".",' >> dist/manifest.json
          echo '  "display": "standalone",' >> dist/manifest.json
          echo '  "icons": [' >> dist/manifest.json
          echo '    {"src": "icons/icon-192.png", "sizes": "192x192"},' >> dist/manifest.json
          echo '    {"src": "icons/icon-512.png", "sizes": "512x512"}' >> dist/manifest.json
          echo '  ]' >> dist/manifest.json
          echo '}' >> dist/manifest.json

      - name: service-worker.js
        run: |
          echo 'self.addEventListener("install",e=>{' > dist/service-worker.js
          echo '  e.waitUntil(caches.open("keymon-cache").then(c=>c.addAll(["./","./index.html","./style.css","./app.js","./manifest.json"])));' >> dist/service-worker.js
          echo '});' >> dist/service-worker.js
          echo 'self.addEventListener("fetch",e=>{' >> dist/service-worker.js
          echo '  e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));' >> dist/service-worker.js
          echo '});' >> dist/service-worker.js

      - name: Criar ícones fake
        run: |
          echo -n "" > dist/icons/icon-192.png
          echo -n "" > dist/icons/icon-512.png

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages

    steps:
      - name: Deploy
        uses: actions/deploy-pages@v4
