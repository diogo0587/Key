name: Auto-generate & Deploy Advanced PWA

on:
  push:
    branches:
      - main

jobs:
  generate-build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create full PWA with Admin
        run: |
          mkdir -p dist/public/icons

          ##############################################
          # index.html - user app
          ##############################################
          cat > dist/index.html <<'HTML'
          <!doctype html>
          <html lang="pt-BR">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>PWA User App</title>
            <link rel="manifest" href="/manifest.json">
            <script defer src="main.js"></script>
          </head>
          <body>
            <h1>PWA User App</h1>
            <p>Digite algo, ser√° registrado automaticamente:</p>
            <input type="text" id="inputBox" placeholder="Digite aqui">
            <ul id="logList"></ul>
          </body>
          </html>
          HTML

          ##############################################
          # admin.html - admin dashboard
          ##############################################
          cat > dist/admin.html <<'HTML'
          <!doctype html>
          <html lang="pt-BR">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Admin Dashboard</title>
            <style>
              body { font-family: sans-serif; }
              #logList li { margin-bottom: 4px; }
              #filter { margin-bottom: 10px; }
            </style>
            <script defer src="admin.js"></script>
          </head>
          <body>
            <h1>Admin Dashboard</h1>
            <input type="text" id="filter" placeholder="Filtrar logs">
            <p>Total: <span id="count">0</span></p>
            <ul id="logList"></ul>
          </body>
          </html>
          HTML

          ##############################################
          # main.js - user logic
          ##############################################
          cat > dist/main.js <<'JS'
          const input = document.getElementById('inputBox');
          const logList = document.getElementById('logList');
          const logs = JSON.parse(localStorage.getItem('userLogs') || '[]');
          function addLog(text){
            const li = document.createElement('li');
            li.textContent = text;
            logList.appendChild(li);
          }
          logs.forEach(addLog);
          input.addEventListener('input', e => {
            const value = e.target.value;
            if(!value) return;
            logs.push(value);
            localStorage.setItem('userLogs', JSON.stringify(logs));
            addLog(value);
            e.target.value='';
          });
          JS

          ##############################################
          # admin.js - admin logic with filter and count
          ##############################################
          cat > dist/admin.js <<'JS'
          const logList = document.getElementById('logList');
          const countEl = document.getElementById('count');
          const filterInput = document.getElementById('filter');
          let logs = JSON.parse(localStorage.getItem('userLogs') || '[]');

          function renderLogs(filter=''){
            logList.innerHTML='';
            const filtered = logs.filter(l=>l.toLowerCase().includes(filter.toLowerCase()));
            filtered.forEach(item => {
              const li = document.createElement('li');
              li.textContent=item;
              logList.appendChild(li);
            });
            countEl.textContent = filtered.length;
          }

          filterInput.addEventListener('input', e=>{
            renderLogs(e.target.value);
          });

          renderLogs();
          JS

          ##############################################
          # manifest.json
          ##############################################
          cat > dist/manifest.json <<'JSON'
          {
            "name": "PWA Auto Input Advanced",
            "short_name": "PWA Teste",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#317EFB",
            "icons": [
              {"src": "/public/icons/icon-192.png","sizes": "192x192","type": "image/png"},
              {"src": "/public/icons/icon-512.png","sizes": "512x512","type": "image/png"}
            ]
          }
          JSON

          ##############################################
          # dummy icons in base64
          ##############################################
          for size in 192 512; do
            echo "iVBORw0KGgoAAAANSUhEUgAA$(($size))AAABAAAAAAAAAAA=" | base64 --decode > dist/public/icons/icon-${size}.png
          done

      - name: List dist folder
        run: ls -R dist

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: pwa-build
          path: ./dist

      - name: Configure Pages
        uses: actions/configure-pages@v3

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          folder: ./dist
