name: Auto-PWA-Builder-and-Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Create PWA structure
        run: |
          mkdir -p src
          mkdir -p public/icons

          # index.html
          cat << 'EOF' > src/index.html
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>PWA Automático</title>
            <link rel="manifest" href="/manifest.json" />
            <script>
              if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js');
              }
            </script>
          </head>
          <body>
            <h1>PWA gerado automaticamente</h1>
            <p>Files criados via GitHub Actions.</p>
          </body>
          </html>
          EOF

          # service worker
          cat << 'EOF' > public/service-worker.js
          self.addEventListener('install', event => {
            console.log('SW instalado');
            self.skipWaiting();
          });

          self.addEventListener('activate', event => {
            console.log('SW ativo');
          });

          self.addEventListener('fetch', event => {
            event.respondWith(fetch(event.request));
          });
          EOF

          # manifest.json
          cat << 'EOF' > public/manifest.json
          {
            "name": "PWA Automático",
            "short_name": "AutoPWA",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#222222",
            "icons": [
              {
                "src": "/icons/icon-192.png",
                "sizes": "192x192",
                "type": "image/png"
              },
              {
                "src": "/icons/icon-512.png",
                "sizes": "512x512",
                "type": "image/png"
              }
            ]
          }
          EOF

          # ÍCONE 192x192 EM BASE64
          cat << 'EOF' > public/icons/icon-192.png.b64
iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAQAAABH5Dq2AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6
JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAA90lEQVR4nO3UsQ2DQBBE0W9KuWQECsQk
S5GIErkCkSqECiELOJgsbR/dbOeGeq/QAdctkziZAAAAAAAAAAAAAAAAAACAyxs7Wm8TzBsuIcBzjKzn
rS8Py2xgAU8zx/4InENcybXUG6uBgnKJfcE94Jxjn1cwXP3v4P3T6PxPzu6pfq+P/AAAAAAAAAAAAAAAA
AAAAAAAAAAAAgH8BDnU3oL4xy+EAAAAASUVORK5CYII=
EOF

          # ÍCONE 512x512 EM BASE64
          cat << 'EOF' > public/icons/icon-512.png.b64
iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAQAAADoGO8FAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6
JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAA/klEQVR4nO3SQQnDMBQEwY0tSsxgQwRa
CxGTFjZgQwyEWSCyEckl5cZZpWpv+LyWcePvXIbb4EhPvG5AAAAAAAAAAAAAAAAAAAAAAAD4czlb+i0H
uC8xwE5hXhmZ9+cOwCzEPmJh3O8PYdn4gmiV97ieYRe3HhVjYxfeG9w3xH+g+8t7sO+/O6p/r6f7AAAA
AAAAAAAAAAAAAAAAAAAAAP4D/JINhLxHcxEAAAAASUVORK5CYII=
EOF

          # decodifica
          base64 --decode public/icons/icon-192.png.b64 > public/icons/icon-192.png
          base64 --decode public/icons/icon-512.png.b64 > public/icons/icon-512.png
          rm public/icons/*.b64

      - name: Generate dist
        run: |
          mkdir -p dist
          cp -R src/* dist/
          cp -R public/* dist/

      - name: Vercel Pull
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        run: vercel deploy dist --prod --yes --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_SCOPE }}
