name: Build-and-Deploy-KeyMonitor-PWA

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Criar estrutura
        run: |
          mkdir -p dist
          mkdir -p dist/icons

      - name: Criar index.html
        run: |
          printf "%s" "
<!doctype html>
<html lang='pt-BR'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Keyboard Monitor</title>
<link rel='stylesheet' href='style.css'>
<link rel='manifest' href='manifest.json'>
</head>
<body>
<header><h1>Keyboard Monitor</h1></header>
<textarea id='area' placeholder='Digite aqui...'></textarea>
<script src='app.js'></script>
<script>
if('serviceWorker' in navigator){
navigator.serviceWorker.register('service-worker.js');
}
</script>
</body>
</html>
" > dist/index.html

      - name: Criar style.css
        run: |
          printf "%s" "
body { background:#f3f3f3; font-family:Arial; margin:0; padding:20px; }
textarea { width:100%; height:200px; font-size:16px; }
" > dist/style.css

      - name: Criar app.js
        run: |
          printf "%s" "
let events=[];
const area=document.getElementById('area');
area.addEventListener('keydown',e=>{
  events.push({key:e.key,code:e.code,time:Date.now()});
});
" > dist/app.js

      - name: Criar manifest.json
        run: |
          printf "%s" '
{
  "name": "Keyboard Monitor",
  "short_name": "KeyMon",
  "start_url": ".",
  "display": "standalone",
  "icons": [
    {"src": "icons/icon-192.png", "sizes": "192x192"},
    {"src": "icons/icon-512.png", "sizes": "512x512"}
  ]
}
' > dist/manifest.json

      - name: Criar service-worker.js
        run: |
          printf "%s" "
self.addEventListener('install',e=>{
  e.waitUntil(
    caches.open('keymon-cache').then(c=>c.addAll(['./','./index.html','./style.css','./app.js','./manifest.json']))
  );
});
self.addEventListener('fetch',e=>{
  e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
});
" > dist/service-worker.js

      - name: Criar Ã­cones fake
        run: |
          printf "%s" "iVBORw0KGgoAAAANSUhEUgAAAAEAAAAB" | base64 --decode > dist/icons/icon-192.png || true
          printf "%s" "iVBORw0KGgoAAAANSUhEUgAAAAEAAAAB" | base64 --decode > dist/icons/icon-512.png || true

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages

    steps:
      - name: Deploy
        uses: actions/deploy-pages@v4
